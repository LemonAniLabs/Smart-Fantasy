# Python è³‡æ–™å›å¡«å·¥å…·ä½¿ç”¨æŒ‡å—

## ç›®çš„

é€™æ˜¯ä¸€å€‹**ä¸€æ¬¡æ€§çš„å¤§é‡è³‡æ–™å»ºåˆ¶å·¥å…·**ï¼Œç”¨æ–¼ï¼š

1. âœ… åˆå§‹åŒ– Supabase è³‡æ–™åº«
2. âœ… å›å¡«æ­·å²è³½å­£è³‡æ–™ï¼ˆ2023-24, 2024-25ï¼‰
3. âœ… å¤§é‡é‡å»ºè³‡æ–™æ™‚ä½¿ç”¨
4. âœ… æ¸¬è©¦èˆ‡é–‹ç™¼ç’°å¢ƒåˆå§‹åŒ–

**é‡è¦**: é€™ä¸æ˜¯ç”¢å“çš„ä¸€éƒ¨åˆ†ã€‚æœªä¾†çš„åŒæ­¥æ©Ÿåˆ¶æœƒä½¿ç”¨ Next.js API + Cron Jobsã€‚

---

## å®‰è£

### 1. å®‰è£ Python ä¾è³´

```bash
cd scripts
pip install -r requirements.txt
```

### 2. è¨­å®šç’°å¢ƒè®Šæ•¸

ç¢ºä¿ `.env` æª”æ¡ˆåŒ…å«ä»¥ä¸‹è®Šæ•¸ï¼š

```env
# Supabase
NEXT_PUBLIC_SUPABASE_URL="https://xxx.supabase.co"
NEXT_PUBLIC_SUPABASE_ANON_KEY="eyJxxx..."

# Yahoo OAuth
YAHOO_CLIENT_ID="dj0yJmk9..."
YAHOO_CLIENT_SECRET="xxx..."

# è¯ç›Ÿ IDï¼ˆé¸å¡«ï¼Œä¹Ÿå¯ä»¥é€éå‘½ä»¤åˆ—åƒæ•¸æŒ‡å®šï¼‰
YAHOO_LEAGUE_ID="12345"
```

### 3. è¨­å®š Yahoo API æ†‘è­‰

åƒè€ƒ [yfpy æ–‡æª”](https://yfpy.uberfastman.com/#setup) å®Œæˆ OAuth è¨­å®šï¼š

1. åœ¨ `~/.yfpy/` ç›®éŒ„ä¸‹å‰µå»º `private.json`:

```json
{
  "consumer_key": "ä½ çš„_YAHOO_CLIENT_ID",
  "consumer_secret": "ä½ çš„_YAHOO_CLIENT_SECRET"
}
```

2. ç¬¬ä¸€æ¬¡åŸ·è¡Œæ™‚ï¼Œyfpy æœƒé–‹å•Ÿç€è¦½å™¨é€²è¡Œ OAuth æˆæ¬Š
3. æˆæ¬Šå¾Œæœƒè‡ªå‹•å„²å­˜ token

---

## ä½¿ç”¨æ–¹å¼

### åŸºæœ¬ç”¨æ³•

```bash
python backfill_data.py <league_id> <season> [max_players]
```

**åƒæ•¸èªªæ˜**:
- `league_id`: Yahoo è¯ç›Ÿ IDï¼ˆå¿…å¡«ï¼‰
- `season`: è³½å­£ä»£ç¢¼ï¼ˆé¸å¡«ï¼Œé è¨­ `2024-25`ï¼‰
  - å¯é¸: `2025-26`, `2024-25`, `2023-24`
- `max_players`: æœ€å¤šè™•ç†çƒå“¡æ•¸ï¼ˆé¸å¡«ï¼Œç”¨æ–¼æ¸¬è©¦ï¼‰

### ç¯„ä¾‹

#### 1. æ¸¬è©¦ç”¨ï¼ˆåªè™•ç†å‰ 5 å€‹çƒå“¡ï¼‰

```bash
python backfill_data.py 12345 2024-25 5
```

#### 2. å›å¡«æ•´å€‹ 2024-25 è³½å­£

```bash
python backfill_data.py 12345 2024-25
```

#### 3. å›å¡« 2023-24 è³½å­£ï¼ˆä¸Šä¸€å­£ï¼‰

```bash
python backfill_data.py 12345 2023-24
```

#### 4. åŒæ­¥ç•¶å‰è³½å­£ï¼ˆ2025-26ï¼‰

```bash
python backfill_data.py 12345 2025-26
```

---

## åŸ·è¡Œæµç¨‹

è…³æœ¬æœƒè‡ªå‹•ï¼š

1. âœ… é€£æ¥ Yahoo Fantasy API
2. âœ… ç²å–è¯ç›Ÿæ‰€æœ‰çƒå“¡åˆ—è¡¨
3. âœ… å°æ¯å€‹çƒå“¡ï¼š
   - æŸ¥è©¢è³‡æ–™åº«ä¸­å·²å­˜åœ¨çš„æ—¥æœŸ
   - åªæ‹‰å–ç¼ºå¤±çš„æ—¥æœŸ
   - å„²å­˜åˆ° Supabase
4. âœ… é¡¯ç¤ºè©³ç´°é€²åº¦å’Œçµ±è¨ˆ

### è¼¸å‡ºç¯„ä¾‹

```
============================================================
ğŸ€ Yahoo Fantasy Basketball è³‡æ–™å›å¡«å·¥å…·
============================================================

âœ“ åˆå§‹åŒ–å®Œæˆ: nba.l.12345 (2025)
ğŸ“‹ æ­£åœ¨ç²å–è¯ç›Ÿçƒå“¡åˆ—è¡¨...
âœ“ æ‰¾åˆ° 200 å€‹çƒå“¡

============================================================
ğŸ€ é–‹å§‹å›å¡« 2024-25 è³½å­£
ğŸ“… æ—¥æœŸç¯„åœ: 2024-10-22 è‡³ 2025-06-17
============================================================

[1/200] LeBron James (nba.p.3704)
------------------------------------------------------------
  å·²å­˜åœ¨: 0 å ´
  æ–°å¢: 45 å ´
  API èª¿ç”¨: 245 æ¬¡

[2/200] Stephen Curry (nba.p.4612)
------------------------------------------------------------
  å·²å­˜åœ¨: 0 å ´
  æ–°å¢: 50 å ´
  API èª¿ç”¨: 245 æ¬¡

...

============================================================
âœ… å›å¡«å®Œæˆï¼
============================================================
è™•ç†çƒå“¡: 200/200
æ–°å¢æ¯”è³½: 9500 å ´
API èª¿ç”¨: 49000 æ¬¡
éŒ¯èª¤: 5 å€‹
============================================================
```

---

## ç‰¹æ€§

### 1. å¢é‡åŒæ­¥

- âœ… è‡ªå‹•æª¢æ¸¬è³‡æ–™åº«ä¸­å·²å­˜åœ¨çš„æ—¥æœŸ
- âœ… åªæ‹‰å–ç¼ºå¤±çš„è³‡æ–™
- âœ… æ”¯æ´æ–·é»çºŒå‚³ï¼ˆå¯éš¨æ™‚ä¸­æ–·ä¸¦é‡æ–°åŸ·è¡Œï¼‰

### 2. Rate Limiting

- âœ… æ¯æ¬¡ API èª¿ç”¨é–“éš” 200ms
- âœ… é¿å…è§¸ç™¼ Yahoo API é™åˆ¶

### 3. éŒ¯èª¤è™•ç†

- âœ… è‡ªå‹•è·³éæ²’æœ‰æ¯”è³½çš„æ—¥æœŸ
- âœ… è¨˜éŒ„éŒ¯èª¤ä½†ç¹¼çºŒåŸ·è¡Œ
- âœ… é¡¯ç¤ºè©³ç´°éŒ¯èª¤çµ±è¨ˆ

### 4. è³‡æ–™å®Œæ•´æ€§

- âœ… ä½¿ç”¨ Supabase upsertï¼ˆè‡ªå‹•å»é‡ï¼‰
- âœ… Unique constraint: `(player_key, game_date)`

---

## æ•ˆèƒ½ä¼°ç®—

### å–®ä¸€çƒå“¡

- ä¸€å€‹è³½å­£ç´„ 250 å¤©
- æ¯å¤©é–“éš” 200ms
- **é ä¼°æ™‚é–“: 50 ç§’**

### æ•´å€‹è¯ç›Ÿ

- 200 å€‹çƒå“¡
- æ¯å€‹çƒå“¡ 50 ç§’
- **é ä¼°æ™‚é–“: ç´„ 3 å°æ™‚**

**å»ºè­°**:
- å…ˆç”¨ `max_players=5` æ¸¬è©¦
- ç¢ºèªç„¡èª¤å¾Œå†åŸ·è¡Œå®Œæ•´å›å¡«
- å¯ä»¥åˆ†æ‰¹åŸ·è¡Œï¼ˆè…³æœ¬æ”¯æ´æ–·é»çºŒå‚³ï¼‰

---

## ç›£æ§èˆ‡é©—è­‰

### æª¢æŸ¥è³‡æ–™å®Œæ•´æ€§

åœ¨ Supabase Dashboard åŸ·è¡Œï¼š

```sql
-- æŸ¥çœ‹æ¯å€‹çƒå“¡çš„æ¯”è³½æ•¸é‡
SELECT
  player_name,
  COUNT(*) as games_count,
  MIN(game_date) as first_game,
  MAX(game_date) as last_game
FROM player_game_logs
GROUP BY player_key, player_name
ORDER BY games_count DESC
LIMIT 20;

-- æŸ¥çœ‹æ¯æ—¥æ¯”è³½æ•¸é‡
SELECT
  game_date,
  COUNT(*) as games
FROM player_game_logs
WHERE game_date >= '2024-10-22'
GROUP BY game_date
ORDER BY game_date DESC;

-- æª¢æŸ¥æ˜¯å¦æœ‰ç¼ºå¤±çš„æ—¥æœŸ
SELECT
  generate_series(
    '2024-10-22'::date,
    CURRENT_DATE,
    '1 day'::interval
  )::date AS date
EXCEPT
SELECT DISTINCT game_date
FROM player_game_logs
WHERE game_date >= '2024-10-22'
ORDER BY date;
```

---

## æ•…éšœæ’é™¤

### å•é¡Œ 1: Yahoo OAuth æˆæ¬Šå¤±æ•—

**è§£æ±ºæ–¹æ³•**:
1. ç¢ºèª `~/.yfpy/private.json` å­˜åœ¨ä¸”æ­£ç¢º
2. åˆªé™¤ `~/.yfpy/token.json` é‡æ–°æˆæ¬Š
3. æª¢æŸ¥ Yahoo Developer Console çš„ redirect URI è¨­å®š

### å•é¡Œ 2: Supabase é€£ç·šå¤±æ•—

**è§£æ±ºæ–¹æ³•**:
1. ç¢ºèª `.env` ä¸­çš„ Supabase æ†‘è­‰æ­£ç¢º
2. æª¢æŸ¥ Supabase å°ˆæ¡ˆæ˜¯å¦å•Ÿç”¨
3. ç¢ºèªè³‡æ–™è¡¨ `player_game_logs` å·²å»ºç«‹

### å•é¡Œ 3: Rate Limit éŒ¯èª¤

**è§£æ±ºæ–¹æ³•**:
1. å¢åŠ  `time.sleep()` çš„å»¶é²æ™‚é–“
2. åˆ†æ‰¹åŸ·è¡Œï¼ˆä½¿ç”¨ `max_players` åƒæ•¸ï¼‰
3. ç­‰å¾…ä¸€æ®µæ™‚é–“å¾Œé‡æ–°åŸ·è¡Œ

---

## æ³¨æ„äº‹é …

1. **é€™æ˜¯ä¸€æ¬¡æ€§å·¥å…·** - åªç”¨æ–¼åˆå§‹åŒ–å’Œå¤§é‡é‡å»º
2. **æœªä¾†ä¸æœƒä½¿ç”¨** - ç”¢å“æœƒä½¿ç”¨ Next.js API + Cron Jobs
3. **éœ€è¦ OAuth** - ç¬¬ä¸€æ¬¡åŸ·è¡Œéœ€è¦ç€è¦½å™¨æˆæ¬Š
4. **è€—æ™‚è¼ƒé•·** - å®Œæ•´å›å¡«å¯èƒ½éœ€è¦æ•¸å°æ™‚
5. **æ”¯æ´æ–·é»çºŒå‚³** - å¯éš¨æ™‚ä¸­æ–·ä¸¦é‡æ–°åŸ·è¡Œ

---

## æœªä¾†çš„åŒæ­¥æ©Ÿåˆ¶ï¼ˆç”¢å“ç’°å¢ƒï¼‰

### æ¯æ—¥è‡ªå‹•åŒæ­¥ (Next.js Cron Job)

è…³æœ¬å®Œæˆåˆå§‹åŒ–å¾Œï¼Œæœªä¾†çš„åŒæ­¥æœƒä½¿ç”¨ï¼š

```typescript
// app/api/cron/daily-sync/route.ts
export async function GET() {
  // 1. æŸ¥è©¢ä»Šå¤©çš„ NBA è³½ç¨‹
  const schedule = await getGamesToday();

  // 2. æ‰¾å‡ºæœ‰æ¯”è³½çš„çƒå“¡
  const playersToUpdate = getPlayersFromGames(schedule);

  // 3. åªåŒæ­¥é€™äº›çƒå“¡çš„æ•¸æ“š
  await batchSyncPlayers(playersToUpdate);

  return Response.json({ success: true });
}
```

**åŸ·è¡Œæ™‚é–“**: æ¯å¤© UTC+8 ä¸­åˆ 12:00ï¼ˆå¤§éƒ¨åˆ†æ¯”è³½å·²çµæŸï¼‰

### å—å‚·ç‹€æ…‹æƒæ (æ¯å°æ™‚)

```typescript
// app/api/cron/injury-check/route.ts
export async function GET() {
  // å¾ NBA API ç²å–å—å‚·å ±å‘Š
  const injuries = await getNBAInjuryReport();

  // æ›´æ–°è³‡æ–™åº«
  await updatePlayerInjuryStatus(injuries);

  return Response.json({ success: true });
}
```

**åŸ·è¡Œæ™‚é–“**: æ¯å°æ™‚

---

å®Œæˆåˆå§‹åŒ–å¾Œï¼Œè«‹åƒè€ƒä¸»è¦çš„å¯¦ä½œæ–‡æª”ç¹¼çºŒé€²è¡Œåˆ†æå¼•æ“é–‹ç™¼ã€‚
